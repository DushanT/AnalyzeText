<!DOCTYPE html lang="en">

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/thomas-lowry/figma-plugin-ds/dist/figma-plugin-ds.css">
  <style>
    ul {
      padding-left: 0;
      list-style: none
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .button-group--vertical {
      flex-direction: column;
      align-items: flex-start;
    }

    details summary {
      margin-bottom: 10px;
    }

    details> :not(summary) {
      margin-left: 10px;
    }

    .text--danger {
      color: var(--figma-color-text-danger)
    }

    body {
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
    }

    hr {
      border: 0;
      border-bottom: 1px solid var(--figma-color-border);
    }

    h1,
    h2,
    h3,
    h4 {
      margin-bottom: 0;
    }

    .button {
      justify-content: center;
      cursor: pointer;
    }

    .button:disabled {
      cursor: default;
    }

    .icon-button .icon {
      pointer-events: none;
    }

    .bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .bar--narrow {
      gap: 0;
    }
    .bar--nowrap {
      flex-wrap: nowrap;
    }

    .bar--stretch {
      flex-wrap: nowrap;
      justify-content: space-between;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .grid-2-item--fullwidth {
      grid-column: span 2;
    }

    .select-menu {
      flex-grow: 1;
    }

    .tooltip {
      font-size: 10px;
      position: absolute;
      top: 0;
      left: 50%;
      transform: translate(-50%, calc(-100% - 8px));
      background: var(--figma-color-text);
      color: var(--figma-color-bg);
      width: 80px;
      padding: 8px;
    }

    .tooltip:after {
      background: inherit;
      content: '';
      position: absolute;
      width: 8px;
      height: 8px;
      bottom: 0;
      left: 50%;
      transform: translate(-50%, 50%) rotate(45deg);
    }

    .tooltip-wide .tooltip {
      width: 130px;
    }

    .icon .tooltip {
      transform: translate(-50%, -100%);
    }

    [data-tooltip] {
      position: relative;
    }

    .alert {
      background: var(--figma-color-bg-warning);
    }
    .icon-button,
    .select-menu__button {
      border-radius: 5px;
    }

    [hidden] {
      display: none;
    }

    .text-center {
      text-align: center;
    }

    .figma-light .text--grey,
    .figma-light .text--grey a {
      color: #7F7F7F;
    }

    .figma-dark .text--grey,
    .figma-dark .text--grey a {
      color: #9C9C9C;
    }
    .figma-dark .text--grey .icon {
      filter: invert(0.5);
    }
    .figma-dark .icon:not(.icon--warning-orange) {
      filter: invert(1);
    }
    .figma-dark .icon-button {
      background: #686868;
    }
    .figma-dark .select-menu__button {
      background-color: #373737;
    }
    .figma-dark .select-menu__label {
      color: var(--figma-color-text);
    }
    .figma-dark .select-menu__caret {
      filter: invert(1);
    }
    .button--secondary {
      background-color: var(--figma-color-bg);
      color: var(--figma-color-text);
      border-color: var(--figma-color-text);
    }
    .flip-h {
      transform: scaleX(-1);
    }
    h2 {
      font-size: 1rem;
    }
    .icon--warning-orange {
      background-image: url("data:image/svg+xml;charset=utf8,%3Csvg fill='none' height='32' width='32' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath clip-rule='evenodd' d='M16 9l8 14H8zm-1 8.5V14h2v3.5zm0 1.5v2h2v-2z' fill='%23f00' fill-rule='evenodd'/%3E%3C/svg%3E");
    }
  </style>
</head>

<body class="type--small">
  <section id="empty" class="m-small">
    <h2 class="mb-xsmall">Loading styles</h2>
    <p>First you need to select text with text styles applied or load your local styles in this figma file.</p>
    <!-- <p id="missing-fonts-alert" class="alert p-xxsmall bar bar--stretch" hidden>
      <span class="icon icon--warning"></span>
      <span>
        You have missing fonts in this file. Please load all the neccessary fonts and try again.
      </span>
    </p> -->
    <div class="button-group">
      <button class='button button--secondary' id="load-base-styles">Load styles from selection</button>
      <button class='button button--secondary' id="load-local-styles">Load local styles</button>
    </div>
  </section>
  <section id="content-wrapper" hidden>
    <section class="m-small">
      <h2 class="mb-xsmall">Loaded styles</h2>

      <div class="mb-xxsmall type--medium ">
        <label for="select-style">Selected comparison style</label>
      </div>
      <div class="bar mb-xxsmall">
        <select id="select-style" class="select-menu">
        </select>
        <button class='icon-button' id="clear-base-styles" aria-label="Clear loaded styles"
          data-tooltip="Clear loaded styles">
          <span class="icon icon--trash"></span>
        </button>
      </div>
      <p class="mb-xxsmall ">Find equally styled nodes for selected style</p>
      <div class="bar mb-small">
        <button class='button button--secondary tooltip-wide' id="find-matching-style-nodes"
          data-tooltip="Find equally styled nodes for selected style">Find equal</button>
        <button class="button button--primary tooltip-wide grid-2-item--fullwidth" id="apply-style"
          data-tooltip="Apply selected style to selected nodes">Apply style</button>
      </div>
      <p class="mb-xxsmall ">Find nodes without style applied</p>
      <div class="bar mb-small">
        <button class='button button--secondary tooltip-wide' id="find-no-style-nodes"
          data-tooltip="Find nodes without style applied">Find empty</button>
        <button class="button button--primary tooltip-wide grid-2-item--fullwidth" id="fix-selected"
          data-tooltip="Fix detached styles in selected nodes">Fix selected</button>
      </div>
    </section>
    <section class="m-small">
      <h2 class="mb-xsmall">Traverse selection</h2>
      <div class="bar bar--stretch">
        <button class='icon-button' id="zoom-prev" aria-label="Zoom to previous node"
          data-tooltip="Zoom to previous node">
          <span class="icon icon--back"></span>
        </button>
        <div>
          <div class="text-center ">Selected (<span id="selected-count">0</span>)</div>
          <div class="text-center ">Selected style: <span id="selected-style">none</span></div>
        </div>
        <button class='icon-button' id="zoom-next" aria-label="Zoom to next node" data-tooltip="Zoom to next node">
          <span class="icon icon--back flip-h"></span>
        </button>
      </div>
    </section>
    <hr>
    <section class="m-small">
      <h2 class="mb-xsmall">Find and Fix all</h2>
      <section class="mb-xsmall">
        <div class="mb-xxsmall">detached text nodes on current page based on loaded styles</div>
        <button class="button button--primary tooltip-wide" id="fix-current-detached"
          data-tooltip="Fix all detached text nodes in current page">Fix current page</button>
      </section>
      <hr>
      <section>
        <div >detached text nodes in all pages based on loaded styles</div>
        <div class="bar bar--narrow bar--nowrap type--xsmall">
          <span class="icon icon--warning-orange"></span> <span class="text--grey">This action can freeze your figma for a few minutes!</span>
        </div>
        <button class="button button--primary-destructive tooltip-wide" id="fix-all-detached"
          data-tooltip="Fix all detached text nodes in all pages (Warning: This action can freeze your figma for a few minutes!)">Fix
          all pages</button>
      </section>
    </section>
    <section class="m-small">
      <div class="bar bar--stretch type--xsmall text--grey">
        <p>Made by <a href="#">Dušan</a> and <a href="#">Lukáš</a><br>from <a href="#">Lighting Beetle*</a></p>
        <a href="https://google.com" class="bar bar--narrow bar--nowrap"><span class="icon icon--warning"></span> <span>Support this plugin</span></a>
      </div>
    </section>
  </section>
  <script src="https://cdn.jsdelivr.net/gh/thomas-lowry/figma-plugin-ds/dist/iife/figma-plugin-ds.js"></script>
  <script>

    const updateSelectElement = (selectElement, styles) => {
      selectElement.innerHTML = `${styles.sort((a, b) => {
        if (a.name < b.name) {
          return -1;
        }
        if (a.name > b.name) {
          return 1;
        }
        return 0;
      }).map(style => `<option value="${style.id}">${style.name}</option>`)}`
    }

    const updateSelectedCount = count => {
      document.getElementById('selected-count').innerHTML = count
    }

    const updateSelectedStyle = style => {
      document.getElementById('selected-style').innerHTML = style
    }

    window.onmessage = event => {
      const msg = event.data.pluginMessage
      const { type, styles, message, selectionLength, selectedStyle } = msg

      const selectElement = document.getElementById('select-style')
      const contentWrapper = document.getElementById('content-wrapper')
      const empty = document.getElementById('empty')

      // if (type === 'missing-fonts') {
      //   document.getElementById('missing-fonts-alert').removeAttribute('hidden')
      //   // document.getElementById('load-base-styles').setAttribute('disabled', true)
      // }

      if (type === 'selection-changed') {
        updateSelectedCount(selectionLength)
        updateSelectedStyle(selectedStyle)
      }

      if (type === 'loaded-styles') {
        updateSelectElement(selectElement, styles)

        empty.setAttribute('hidden', true)
        contentWrapper.removeAttribute('hidden')

        //initialize all select menus
        selectMenu.init();
      }

      if (type === 'clear-styles') {
        //uninitialize all select menus
        selectMenu.destroy();

        selectElement.innerHTML = ''
        contentWrapper.setAttribute('hidden', true)
        empty.removeAttribute('hidden')
      }
    }

    const postMessage = (options) => {
      parent.postMessage({ pluginMessage: options }, '*')
    }

    const matchingButtonId = 'find-matching-style-nodes'
    document.getElementById(matchingButtonId).onclick = () => {
      const id = document.getElementById('select-style').selectedOptions?.[0]?.value
      postMessage({ type: matchingButtonId, id })
    }

    const applyButtonId = 'apply-style'
    document.getElementById(applyButtonId).onclick = () => {
      const id = document.getElementById('select-style').selectedOptions?.[0]?.value
      postMessage({ type: applyButtonId, id })
    }

    const buttonIds = [
      'load-base-styles',
      'load-local-styles',
      'clear-base-styles',
      'find-no-style-nodes',
      'zoom-prev',
      'zoom-next',
      'fix-all-detached',
      'fix-current-detached',
      'fix-selected'
    ]

    buttonIds.forEach(buttonId => {
      document.getElementById(buttonId).onclick = () => {
        postMessage({ type: buttonId })
      }
    })

    const tooltip = document.createElement('div')
    tooltip.className = 'tooltip'

    document.querySelectorAll('[data-tooltip]').forEach(el => {
      el.addEventListener('mouseenter', (e) => {
        tooltip.innerText = e.currentTarget.getAttribute('data-tooltip')
        e.currentTarget.appendChild(tooltip)
      })
      el.addEventListener('mouseleave', (e) => {
        e.currentTarget.querySelector('.tooltip').remove()
      })
    })

    // document.getElementById('search-all-pages').onchange = (e) => {
    //   if (e.currentTarget.checked) {
    //     postMessage({ type: 'search-all-pages-on' })
    //   } else {
    //     postMessage({ type: 'search-all-pages-off' })
    //   }
    // }


  </script>
</body>